#!/bin/sh

## Brightbox Builder - Live Build Scripts
## Copyright (C) 2011 Brightbox Systems Ltd
## Author: Neil Wilson
##
## brightbox-builder comes with ABSOLUTELY NO WARRANTY; for details see COPYING.
## This is free software, and you are welcome to redistribute it
## under certain conditions; see COPYING for details.


set -e

# Including common functions
. "${LB_BASE:-/usr/share/live/build}"/scripts/build.sh

# Setting static variables
DESCRIPTION="$(Echo 'remove block mappings')"
HELP=""
USAGE="${PROGRAM} [--force]"

Arguments "${@}"

# Reading configuration files
Read_conffiles config/all config/common config/bootstrap config/chroot config/binary config/source
Set_defaults

if ! In_list virtual-hdd "${LB_BINARY_IMAGES}"
then
	exit 0
fi



# Checking lock file
Check_lockfile .lock

# Creating lock file
Create_lockfile .lock


Echo_message "Remove kvm virtual disk mappings..."

kvm_image=kvm-virtual.img

disk_prefix=msda
if [ -e "/dev/${disk_prefix}" ]
then
	loop_device=$(${LB_ROOT_COMMAND} ${LB_LOSETUP} -a | grep "${kvm_image}" | cut -d':' -f1)
	${LB_ROOT_COMMAND} kpartx -dv /dev/mapper/${disk_prefix}
	${LB_ROOT_COMMAND} dmsetup remove /dev/mapper/${disk_prefix}
	${LB_ROOT_COMMAND} ${LB_LOSETUP} -d "${loop_device}"
	${LB_ROOT_COMMAND} rm -f /dev/${disk_prefix}*
fi

rm -f .stage/kvm_diskmap

