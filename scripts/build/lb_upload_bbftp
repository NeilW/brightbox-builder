#!/bin/sh

## live-build(7) - System Build Scripts
## Copyright (C) 2011 Brightbox Systems
## Author: Neil Wilson
##
## live-build comes with ABSOLUTELY NO WARRANTY; for details see COPYING.
## This is free software, and you are welcome to redistribute it
## under certain conditions; see COPYING for details.


set -e

# Including common functions
. "${LB_BASE:-/usr/share/live/build}"/scripts/build.sh

# Setting static variables
DESCRIPTION="$(Echo 'Upload binary image to FTP site')"
HELP=""
USAGE="${PROGRAM} [--force]"

Arguments "${@}"

# Reading configuration files
Read_conffiles config/all config/common config/bootstrap config/chroot config/binary config/source
Set_defaults

Echo_message "Begin uploading image to FTP"

# Requiring stage file
Require_stagefile .stage/kvm_hdd

# Checking stage file
Check_stagefile .stage/bb_upload

# Checking lock file
Check_lockfile .lock

# Creating lock file
Create_lockfile .lock

if ! which brightbox-config > /dev/null 2>&1
then
	Echo_error "Can't find brightbox tools. Install brightbox-cli package and configure an api client"
	exit 1
fi

if ! brightbox-accounts -s list > /dev/null 2>&1
then
	Echo_error "No accounts found. Check your api configuration with 'brightbox-config'" 
	exit 1
fi

BB_CONFIG=$(brightbox-config client_list 2>&1 | awk '/*/{sub(/*/,""); print $1}')
BB_ACCOUNT=$(brightbox-accounts -s list 2>/dev/null | awk '{print $1}')

BB_FTP_URL=$(brightbox-accounts -s reset_ftp_password 2>/dev/null | awk '{ ftp_hash[$1] = $2 }; END { printf "ftp://%s:%s@%s/incoming",ftp_hash["library_ftp_user:"],ftp_hash["library_ftp_password:"],ftp_hash["library_ftp_host:"] }')

Echo_message "Uploading image using '${BB_CONFIG}' configuration"
Echo_message "FTP destination: ${BB_FTP_URL}"


# Creating stage file
Create_stagefile .stage/bb_upload
